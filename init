#!/bin/bash
set -euo pipefail
#
# install.sh
# bash <(curl -Ls https://raw.githubusercontent.com/kwoods/CONFIG.SYS/master/init)

#set -u  # Exit if using undefined variables
#set -e  # Die on failures
#set -x  # Echo all commands

############################################
# Helper functions
############################################
STATE_FILE="$HOME/.config-sys/state"
mkdir -p "$(dirname "$STATE_FILE")"

# Parse command line arguments
if [[ "${1:-}" == "--force" ]]; then
    FORCE_UPDATE=true
    rm -f "$STATE_FILE"  # Clear state to force reinstall
    echo "üîÑ Force mode enabled"
fi

update_config_with_backup() {
    local url=$1
    local destination=$2
    local force=${3:-false}  # Optional third parameter to force update
    local temp_file=$(mktemp)
    local backup_dir="$HOME/.config-backups/$(date +%Y%m%d-%H%M%S)"
    local config_name=$(basename "$destination")
    
    # Download the new config to a temp file
    echo "üì° Downloading latest $config_name..."
    if ! curl -Ls "$url" --output "$temp_file"; then
        echo "‚ùå Failed to download $config_name from $url"
        rm -f "$temp_file"
        return 1
    fi
    
    # Check if destination file exists
    if [[ -f "$destination" ]]; then
        if [[ "$force" == "true" ]]; then
            echo "üîÑ Force mode: backing up and updating $config_name"
            mkdir -p "$backup_dir"
            cp "$destination" "$backup_dir/$config_name"
            echo "üíæ Backed up existing $config_name to $backup_dir/"
        elif diff -q "$destination" "$temp_file" >/dev/null 2>&1; then
            echo "‚úÖ $config_name already up to date"
            rm -f "$temp_file"
            return 0
        else
            # Files differ - show diff and create backup
            echo "üìã Changes detected in $config_name:"
            echo "   Lines changed: $(diff "$destination" "$temp_file" | grep -c '^[<>]' || echo 0)"
            
            mkdir -p "$backup_dir"
            cp "$destination" "$backup_dir/$config_name"
            echo "üíæ Backed up existing $config_name to $backup_dir/"
            
            # Optionally show the actual diff (uncomment if desired)
            # echo "üìù Diff preview:"
            # diff -u "$destination" "$temp_file" | head -20
        fi
    else
        echo "üìù Creating new $config_name (no existing file found)"
    fi
    
    # Move the new config into place
    mv "$temp_file" "$destination"
    echo "‚úÖ Updated $config_name"
}

# Usage with force option support
FORCE_UPDATE=${FORCE:-false}  # Can be set via environment variable

# Function to check if step was completed
step_completed() {
    grep -q "^$1$" "$STATE_FILE" 2>/dev/null
}

# Function to mark step as completed
mark_completed() {
    echo "$1" >> "$STATE_FILE"
}

############################################
# main section
############################################
# Zsh Envionment
echo "üìù Updating shell configuration..."
update_config_with_backup "https://raw.githubusercontent.com/kwoods/CONFIG.SYS/master/zsh/.zshrc" ~/.zshrc
update_config_with_backup "https://raw.githubusercontent.com/kwoods/CONFIG.SYS/master/zsh/.zsh_plugins.txt" ~/.zsh_plugins.txt

# Check if packages are already installed
echo "‚öôÔ∏è  Configuring Homebrew..."
echo "üç∫ Checking for Homebrew..."

if ! command -v brew &> /dev/null; then
    echo "üì¶ Homebrew not found. Installing Homebrew..."
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
    
    # Add Homebrew to PATH immediately for this session
    if [[ -f "/opt/homebrew/bin/brew" ]]; then
        # Apple Silicon Mac
        echo "üîß Adding Homebrew to PATH (Apple Silicon)"
        export PATH="/opt/homebrew/bin:$PATH"
        eval "$(/opt/homebrew/bin/brew shellenv)"
    elif [[ -f "/usr/local/bin/brew" ]]; then
        # Intel Mac
        echo "üîß Adding Homebrew to PATH (Intel)"
        export PATH="/usr/local/bin:$PATH"
        eval "$(/usr/local/bin/brew shellenv)"
    fi
    
    echo "‚úÖ Homebrew installed successfully"
else
    echo "‚úÖ Homebrew already installed"
fi

# Verify brew is now available
if ! command -v brew &> /dev/null; then
    echo "‚ùå Error: Homebrew installation failed or PATH not set correctly"
    exit 1
fi
curl -Ls https://raw.githubusercontent.com/kwoods/CONFIG.SYS/master/Brewfile_base --output ~/Brewfile_base

if brew bundle check --file=~/Brewfile_base; then
    echo "‚úÖ All base packages already installed"
else
    echo "üì¶ Installing missing base packages..."
    brew bundle --file=~/Brewfile_base
fi
rm -f ~/Brewfile_base

# Fix PATH for Apple Silicon Macs
if ! grep -q "/opt/homebrew/bin" ~/.zshrc 2>/dev/null; then
    echo 'export PATH="/opt/homebrew/bin:$PATH"' >> ~/.zshrc
    echo "‚úÖ Added Homebrew to PATH"
else
    echo "‚úÖ Homebrew already in PATH"
fi

echo "‚öôÔ∏è  Configuring VSCode..."
#sudo xattr -dr com.apple.quarantine /Applications/Visual\ Studio\ Code.app

# Check if VSCode is running and warn user
if pgrep -x "Visual Studio Code" > /dev/null; then
    echo "‚ö†Ô∏è  Please close VSCode before continuing..."
    read -p "Press Enter after closing VSCode..."
fi

echo "üì¶ Installing VSCode extensions..."
code --install-extension "be5invis.vscode-custom-css" --force
code --install-extension "Tyriar.sort-lines" --force
code --install-extension "webrender.synthwave-x-fluoromachine" --force
code --install-extension "streetsidesoftware.code-spell-checker" --force
code --install-extension "mikestead.dotenv" --force
code --install-extension "yzhang.markdown-all-in-one" --force
code --install-extension "chenzhe.split-line" --force
code --install-extension "jzarzoso.break-from-comma" --force
code --install-extension "ms-python.python" --force
echo "‚úÖ VSCode extensions installation complete"

export SYNTHWAVE_PLUGIN_VER=$(code --list-extensions --show-versions | grep synthwave-x-fluoromachine | cut -d @ -f 2)

echo "üìù Updating VSCode settings..."
mkdir -p ~/Library/Application\ Support/Code/User
update_config_with_backup "https://raw.githubusercontent.com/kwoods/CONFIG.SYS/master/vscode/settings.json" ~/Library/Application\ Support/Code/User/settings.json

#TODO: make fluoromachine var for version
#cp ~/.vscode/extensions/webrender.synthwave-x-fluoromachine-${SYNTHWAVE_PLUGIN_VER}/synthwave-x-fluoromachine.itermcolors ~/Library/Application\ Support/iTerm2/DynamicProfiles/synthwave-x-fluoromachine.itermcolors
echo "üìù Updating iTerm2 profile..."
mkdir -p ~/Library/Application\ Support/iTerm2/DynamicProfiles
update_config_with_backup "https://raw.githubusercontent.com/kwoods/CONFIG.SYS/master/iterm/synthwave-profile.json" ~/Library/Application\ Support/iTerm2/DynamicProfiles/synthwave-profile.json


# Dev Environment
echo "‚öôÔ∏è  Configuring Dev Environment..."
curl -Ls https://raw.githubusercontent.com/kwoods/CONFIG.SYS/master/Brewfile_python --output ~/Brewfile_python

if brew bundle check --file=~/Brewfile_python; then
    echo "‚úÖ All Python packages already installed"
else
    echo "üì¶ Installing missing Python packages..."
    brew bundle -v --file=~/Brewfile_python
fi

# Clean up temp file
rm -f ~/Brewfile_python


